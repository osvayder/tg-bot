# ОТЧЕТ О ПРОБЛЕМАХ И ИСПРАВЛЕНИЯХ
**Дата:** 2025-08-23
**Исполнитель:** Claude Code

## ОБНАРУЖЕННЫЕ ПРОБЛЕМЫ

### Проблема 1: Группы не наследуются в поддепартаментах
**Описание:** Если в родительский департамент назначена группа, она не подцепляется в поддепартаменте
**Причина:** Отсутствует связь между TgGroup и Department в модели

### Проблема 2: Автоматическое создание проектов для новых групп  
**Описание:** При первом сообщении в группу без проекта создается новый проект автоматически
**Причина:** В боте есть логика автосоздания проектов (нужно проверить bot/main.py)

### Проблема 3: Участники не синхронизируются при привязке группы к проекту
**Описание:** После привязки группы к проекту участники не добавляются в ProjectMember автоматически
**Причина:** Метод _sync_project_members_from_logs в TgGroupAdmin не срабатывает корректно

### Проблема 4: В поддепартаментах нельзя выбрать пользователей
**Описание:** Фильтры не показывают пользователей проекта
**Причина:** ProjectMember пуст после привязки группы

## АНАЛИЗ КОДА

### Обнаружено в bot/main.py (строки 73-83):
```python
# Автоматическое создание TgGroup для ЛЮБОЙ группы
if msg.chat and msg.chat.type in ("group", "supergroup") and compact["chat_id"]:
    await conn.execute("""
        INSERT INTO core_tggroup (telegram_id, title, created_at)
        VALUES ($1, $2, NOW())
        ON CONFLICT (telegram_id)
        DO UPDATE SET title = EXCLUDED.title
    """)
```
**Проблема:** Бот автоматически создает запись TgGroup для любой группы без привязки к проекту

### Обнаружено в admin/core/admin.py (строки 307-315):
```python
# Синхронизация участников при сохранении TgGroup
if obj.project_id and obj.telegram_id:
    default_role = Role.objects.filter(name__iexact="Member").first()
    self._sync_project_members_from_logs(...)
```
**Статус:** Код корректный, но нужно проверить работу метода

## ПЛАН ИСПРАВЛЕНИЙ

### Исправление 1: Убрать автосоздание проектов в боте
**Файл:** bot/main.py
**Действие:** Изменить логику создания TgGroup - НЕ назначать проект автоматически

### Исправление 2: Добавить связь группы с департаментами
**Файл:** admin/core/models.py
**Действие:** Добавить поле department в TgGroup (опционально)

### Исправление 3: Исправить фильтры пользователей в поддепартаментах
**Файл:** admin/core/admin.py
**Действие:** Проверить и исправить DepartmentMemberInline

### Исправление 4: Добавить принудительную синхронизацию
**Файл:** admin/core/admin.py
**Действие:** Добавить кнопку синхронизации в админку TgGroup

## ВЫПОЛНЕННЫЕ ИСПРАВЛЕНИЯ

### ✅ Исправление 1: Отключено автосоздание проектов
**Файл:** bot/main.py (строки 77-81)
**Изменение:** Добавлен явный NULL для project_id при создании новой группы
```python
INSERT INTO core_tggroup (telegram_id, title, created_at, project_id)
VALUES ($1, $2, NOW(), NULL)
```
**Результат:** Новые группы создаются БЕЗ привязки к проекту

### ✅ Исправление 2: Улучшена автосинхронизация участников
**Файл:** admin/core/admin.py (строки 310-321)
**Изменения:**
- Автоматическое создание роли "Member" если её нет
- Добавлено сообщение об успешной синхронизации
- Исправлена логика создания пользователей из raw_updates

### ✅ Исправление 3: Добавлена кнопка ручной синхронизации
**Файл:** admin/core/admin.py (строки 219-237)
**Добавлено:** Action "Синхронизировать участников из логов" в списке групп

### ✅ Исправление 4: Улучшены фильтры пользователей
**Файл:** admin/core/admin.py (строки 757-772)
**Изменения:**
- Добавлена отладочная информация
- Если в проекте нет участников - показываются ВСЕ пользователи системы
- Это позволит добавить первых участников вручную

## КАК ИСПОЛЬЗОВАТЬ ИСПРАВЛЕНИЯ

### 1. Пересобрать контейнеры:
```bash
docker-compose build bot admin
docker-compose up -d
```

### 2. Процесс работы с группами:
1. Группа автоматически создается при первом сообщении (БЕЗ проекта)
2. В админке вручную привязываем группу к проекту
3. При сохранении автоматически синхронизируются участники
4. Можно также использовать кнопку "Синхронизировать участников из логов"

### 3. Работа с департаментами:
1. Создаем проект
2. Привязываем группу к проекту (участники синхронизируются)
3. Создаем департаменты
4. В поддепартаментах теперь видны участники проекта

## ОСТАВШАЯСЯ ПРОБЛЕМА

### Проблема 1: Группы не наследуются в департаментах
**Статус:** Требует дополнительного анализа
**Причина:** В модели Department нет связи с TgGroup
**Решение:** Нужно добавить ManyToMany связь между Department и TgGroup

## КОРЕНЬ ПРОБЛЕМЫ - ПОЧЕМУ ПЕРЕСТАЛО РАБОТАТЬ

### ЧТО ПРОИЗОШЛО:
После выполнения задач P1/02-P1/05 и переноса на GitHub была **СБРОШЕНА БАЗА ДАННЫХ** командой `docker-compose down -v`

### ПОСЛЕДСТВИЯ:
1. **Таблица raw_updates ПУСТАЯ** - нет истории сообщений из групп
2. **Таблица core_projectmember ПУСТАЯ** - нет связей пользователь-проект
3. **В core_user только 2 записи** - только админы, нет остальных пользователей

### ПОЧЕМУ НЕ РАБОТАЕТ:
1. **Синхронизация участников** опирается на данные из raw_updates
2. **Карточка пользователя** показывает привязки из ProjectMember (пусто)
3. **Фильтры в департаментах** ищут участников в ProjectMember (пусто)

### КАК ИСПРАВИТЬ:

#### Вариант 1: Восстановить данные из бэкапа
```bash
# Если есть бэкап БД до сброса
docker-compose exec db psql -U bot -d botdb < backup.sql
```

#### Вариант 2: Накопить новые данные
1. Написать несколько сообщений в группы бота
2. Создать проекты и привязать группы
3. Запустить синхронизацию:
```bash
docker-compose exec admin python manage.py sync_project_members
```

#### Вариант 3: Создать тестовые данные
```bash
docker-compose exec admin python manage.py shell -c "
from core.models import *
# Создать тестовые записи в raw_updates
# Создать ProjectMember связи
# и т.д.
"
```

## ВАЖНОЕ ЗАМЕЧАНИЕ

Проблема НЕ в коде! Код работает правильно, но **нет данных** после сброса БД.
Все исправления валидны и будут работать как только появятся данные в raw_updates.

## РЕКОМЕНДАЦИИ КООРДИНАТОРУ

1. **НЕ СБРАСЫВАТЬ БД** при обновлениях кода
2. Делать бэкапы перед критическими изменениями
3. Использовать миграции для изменения схемы, а не пересоздание
4. Добавить команду для импорта истории из Telegram